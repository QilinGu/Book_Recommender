{% extends "base.html" %}


{% block content %}
{{ super() }}
  
  <div class="row" style="padding-bottom: 30px; padding-top: 30px">
  	<h4>Let's find your next book!</h4>
<meta name="csrf-token" content="{{ csrf_token() }}">
   </div>
<div class=row style='box-shadow: inset 0 0 12px 7px lightgray; height: 400px;overflow:scroll; padding: 15px'>
<div class=row>
  {% set n = 0 %}
  {% for book_read in current_user.books_read %}	
  {% set n = n+1 %}
  {% set book = db.session.query(Book).filter_by(id=book_read.book_id).first()%}
  	{% with author=book.author, title=book.title, web_id=book.web_id, n=n, current_rating=book_read.rating, book_id=book.id %}
      {% include 'recommendations_book.html' %} 
  	{% endwith %}
 	{% endfor %}
 </div>
 </div>

<div class="row">
<div class="shrink columns">
 <div class="chexbox-column">
  <div>
    <input type="checkbox" id="cb14" value="adventure" onclick="check_box(this)" /><label for="c12>">Adventure</label> 
  </div>
 <div>
      <input type="checkbox" id="cb10" value="autobiography" onclick="check_box(this)" /><label for="cb9>">Autobiography</label>
  </div>
  <div>
    <input type="checkbox" id="cb9" value="biography" onclick="check_box(this)" /><label for="cb8>">Biography</label>
  </div> 
  <div>
    <input type="checkbox" id="cb7" value="humor" onclick="check_box(this)"/><label  for="cb6>">Comedy</label> 
  </div>  
</div>
</div>


<div class="shrink columns">
<div class="chexbox-column">
  <div>
    <input type="checkbox" id="cb14" value="drama" onclick="check_box(this)" /><label for="c12>">Drama</label>
  </div>
  <div>
    <input type="checkbox" id="cb14" value="dystopoian" onclick="check_box(this)" /><label for="c12>">Dystopian</label> 
  </div>
  <div>
    <input type="checkbox" id="cb5" value="fantasy" onclick="check_box(this)"/><label  for="cb5">Fantasy</label> 
  </div>
  <div>
    <input type="checkbox" id="cb2" value="feminist" onclick="check_box(this)"/><label  for="cb2">Feminist</label> 
  </div>
</div>
</div>


<div class="shrink columns">
<div class="chexbox-column">

  <div>
    <input type="checkbox" id="cb14" value="graphic-novel" onclick="check_box(this)" /><label for="c12>">Graphic Novel</label>
  </div>
  <div>
  <input type="checkbox" id="cb8" value="historical" onclick="check_box(this)"/><label  for="c7>">Historical</label> 
  </div>
  <div>
    <input type="checkbox" id="cb3" value="magic" onclick="check_box(this)"/><label  for="cb3">Magic</label> 
  </div>
  <div> 
    <input type="checkbox" id="cb12" value="military" onclick="check_box(this)" /><label for="c10>">Military</label>
  </div>

</div>
</div>



<div class="shrink columns">
<div class="chexbox-column">

  <input type="checkbox" id="cb14" value="mystery" onclick="check_box(this)" /><label for="c12>">Mystery</label>
  <div>
    <input type="checkbox" id="cb14" value="religion" onclick="check_box(this)" /><label for="c12>">Religion</label> 
  </div>
  <div>
      <input type="checkbox" id="cb14" value="romance" onclick="check_box(this)" /><label for="c12>">Romance</label>
  </div>
  <div>
      <input type="checkbox" id="cb13" value="science" onclick="check_box(this)" /><label for="c11>">Science</label> 
  </div>

  </div>
  </div>


<div class="shrink columns">
<div class="chexbox-column">

  <div>
    <input type="checkbox" id="cb14" value="thriller" onclick="check_box(this)" /><label for="c12>">Thriller</label>
  </div>
  <div>
      <input type="checkbox" id="cb4" value="nature" onclick="check_box(this)"/><label for="cb4">Wildlife and Nature</label> 
  </div>
  <div>
      <input type="checkbox" id="cb1" value="young-adult" onclick="check_box(this)"/><label  for="cb1">Young Adult</label>
  </div>
</div>
</div>
</div>
</div>
</div>

<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="../static/js/vendor/rating.min.js"></script>
<script src="../static/js/vendor/rating_script.js"></script>

<script>


$(document).ready(function ()  {
    $(".recCover").click(function() {
      $(this).toggleClass("HL");  
    });
  });



(function init() {
	var lastBookDiv = document.querySelectorAll(['.c-rating']);
	 	for (var i = 1; i < lastBookDiv.length+1; i++) {
		 	console.log('list item number:')
      var iter = i.toString()
      var iterId = 'iter'.concat(iter)
      var bookElem = document.getElementById(iterId);   
      var webIdElem = bookElem.querySelector('.current_rating_div');
      current_rating = webIdElem.id 
	    addRatingWidget(bookElem, current_rating);
      }
})

();function sendBookData(rating, ratingElement, bookWebId, bookElem){
    	$.ajaxSetup({
            headers:
            { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') }
        });

    	    console.log(JSON.stringify({"rating": [[bookWebId], [rating]]}))
       $.ajax({

         type: "POST",
         contentType: "application/json; charset=utf-8",
         url: "{{ url_for('main.rating') }}",
         dataType: "json",
         async: true,
         data: JSON.stringify({"rating": [bookWebId, rating]}),   
         success: function (data) {
         console.log('successfully rated:');
          console.log(data);
          addClearRating(bookElem, ratingElement)
         },
         error: function (result) {
         console.log('you messed up')
         }
       })
     }


function deleteReadRecord(book_id){
      $.ajaxSetup({
            headers:
            { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') }
        });

       $.ajax({

         type: "POST",
         contentType: "application/json; charset=utf-8",
         url: "{{ url_for('main.delete_read') }}",
         dataType: "json",
         async: true,
         data: JSON.stringify({"book_info": [book_id]}),   
         success: function (data) {
         console.log('successfully deleted:');
          console.log(data);
         },
         error: function (result) {
         console.log('you messed up')
         }
       })
     }

function removeBook(book_info){
  var book_id = book_info[0]
  var i = book_info[1]
  var iter = i.toString()
  var iterId = 'iter'.concat(iter)
  var BookElem = document.getElementById(iterId)
  deleteReadRecord(book_id)
  BookElem.parentNode.removeChild(BookElem)



}

     function cearRatingClick(ratingElement, bookElem, clearRatingElem){
                            	ratingElement.innerHTML='';
                            	addRatingWidget(bookElem, 0)
                            	clearRatingElem.parentNode.removeChild(clearRatingElem)}

     function addClearRating(bookElem, ratingElement){    	                            
     	var clearRatingElem = document.createElement("p")
     	clearRatingElem.className = 'clearRatingElem';
     	clearRatingElem.innerHTML = 'Clear Rating';
      book_id = bookElem.querySelector('.book_id').id;
      console.log(book_id);
     	clearRatingElem.onclick = function () {
                            	ratingElement.innerHTML='';
                            	addRatingWidget(bookElem, 0)
                            	clearRatingElem.parentNode.removeChild(clearRatingElem)
                              deleteReadRecord(book_id)}

      console.log('worked')                        
      ratingElement.parentNode.lastElementChild.appendChild(clearRatingElem)


     }


    // ADD RATING WIDGET
    function addRatingWidget(bookElem, currentRating) {
    	
      console.log('function called');
      var ratingElement = bookElem.querySelector('.c-rating');
      console.log(bookElem)
      console.log(ratingElement);
      console.log(bookWebId)
      var bookWebId = ratingElement.parentNode.id;
      console.log(bookWebId);
      var maxRating = 5;
      var callback = function(rating, bookWebId, ratingElement) {
      	var ratingElement = bookElem.querySelector('.c-rating')
      	var bookWebId = ratingElement.parentNode.id;
      	sendBookData(rating, ratingElement, bookWebId, bookElem)
      	 }
      var r = rating(ratingElement, currentRating, maxRating, callback);  
    }
</script>
 
{% endblock %}






{% block scripts %}
{{ super() }}
<script src="../static/js/vendor/rating.min.js"></script>
<script src="../static/js/rating_script.js"></script>



{% endblock %}
